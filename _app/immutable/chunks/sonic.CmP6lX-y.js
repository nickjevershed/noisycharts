var A=Object.defineProperty;var b=(p,e,s)=>e in p?A(p,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):p[e]=s;var w=(p,e,s)=>b(p,typeof e!="symbol"?e+"":e,s);import{o as R,D as E,w as T,u as k,y as S,M as Y,S as F,B as X,P as _,T as I,k as c,p as B,A as $,h as K,l as D,r as L,v as P,x as v}from"./2.u76Hl-8z.js";const j={envelope:{attack:0,decay:.1,sustain:0,release:.1},oscillator:{modulationFrequency:.2,type:"sine"}},V=p=>new Promise(e=>setTimeout(e,p)),M=R(["red"]),N={xColumn:null,audioRendering:null,invertY:null,type:null,interval:null,xFormat:{date:null,string:null,number:null,status:"",type:null}};class U{constructor({chartSettings:e=N,noisyChartSettings:s=null,dataKeys:n=[],animationID:i=null,x:t=null,y:o=null,colors:a=M}){w(this,"playAudio",e=>new Promise(async(s,n)=>{console.log("options",this.options);let i=this;c.stop(),c.cancel(),e.forEach(async function(t){let o=i.dataKeys.indexOf(t);console.log("keyIndex",o),console.log("note",i.note),console.log(`Setting up the transport for ${t}`),console.log("audioRendering",i.audioRendering,i.synths[o]),(i.options.audioRendering=="discrete"||i.options.audioRendering=="continuous")&&(i.synths[o].sync(),i.click.sync());let a=i.sonicData[t];i.currentIndex!=0&&(a=a.slice(i.currentIndex));for(let u=0;u<a.length;u++){const l=a[u];i.currentKey=t,i.options.audioRendering=="discrete"?(l[t]?i.synths[o].triggerAttackRelease(i.scale(l[t]),i.note,i.note*u):i.click.triggerAttackRelease(440,i.note,i.note*u),c.schedule(function(){i.currentIndex=l.sonic_index,i.options.animationStyle=="playthrough"&&l[t]&&i.chartAnimation(i.note,t,l.sonic_index,a.length)},u*i.note)):i.options.audioRendering=="continuous"?(console.log("making continuous noise"),console.log(a.length),u==0?(i.synths[o].triggerAttackRelease(i.scale(l[t]),a.length*i.note,0),i.chartAnimation(i.note,t,l.sonic_index,a.length)):c.schedule(function(){i.synths[o].frequency.rampTo(i.scale(l[t]),i.note),i.chartAnimation(i.note,t,l.sonic_index,a.length)},u*i.note),i.currentIndex=l.sonic_index):i.options.audioRendering=="categorical"&&(await i.speaker(l[i.xVar]),i.animationID&&i.animateCursor(t,u,null),await i.beep(i.scale(l[t])))}c.schedule(function(){console.log("the end"),i.currentIndex=0,i.isPlaying=!1,i.options.simultaneous||s({status:"success"})},a.length*i.note),o===i.dataKeys.length-1&&c.schedule(function(){console.log("the actual end"),i.inProgress=!1,i.usedCursor=!1,i.options.simultaneous&&s({status:"success"})},a.length*i.note)}),c.position="0:0:0",c.start(),i.inProgress=!0,i.isPlaying=!0}));w(this,"playFurniture",()=>new Promise((e,s)=>{let n=this;async function i(){let t=n.settings.domainY[0],o=n.settings.domainY[1],a=n.settings.domainX[0],u=n.settings.domainX[1],l=a,m=u;n.settings.cols[0].type=="date"&&(l=v(a,n.settings.xAxisDateFormat),m=v(u,n.settings.xAxisDateFormat));let d=t,y=o;typeof t=="number"&&(d=P(t),y=P(o)),n.furniturePlaying=!0,console.log("lowestVal",n.lowestVal,n.lowestVal[n.xVar],n.xVar),n.options.chartMode==="fully accessible"?(await n.speaker(`The lowest value on the chart is ${d}, and it sounds like `),n.animateCircle(n.lowestVal[n.xVar],n.lowestVal.value,n.lowestVal.key),await n.beep(n.scale(t)),await V(1200),await n.speaker(`The highest value on the chart is ${y}, and it sounds like `),n.animateCircle(n.highestVal[n.xVar],n.highestVal.value,n.highestVal.key),await n.beep(n.scale(o)),await V(1200),(n.options.audioRendering=="discrete"||n.options.audioRendering=="continuous")&&(console.log("yeah3"),await n.speaker(`Each note is ${n.options.interval}, and the chart goes from ${l} to ${m}`))):n.options.chartMode==="human does voiceover"&&(n.animateCircle(n.lowestVal[n.xVar],n.lowestVal.value,n.lowestVal.key),await n.beep(n.scale(t)),await V(1200),n.animateCircle(n.highestVal[n.xVar],n.highestVal.value,n.highestVal.key),await n.beep(n.scale(o)),await V(1200)),n.furniturePlaying=!1,e({status:"success"})}i()}));w(this,"handleKeyPress",e=>{let s=this;console.log(e.code),e.code==="Space"&&this.playPause(),e.code==="KeyD"&&(console.log("keyd"),s.moveCursor(1)),e.code==="KeyA"&&s.moveCursor(-1),e.code==="KeyW"&&s.moveSeries(1),e.code==="KeyS"&&s.moveSeries(-1),e.code==="KeyR"&&s.restart()});this.destination=E,this.synths=[],this.kickDrum=null,this.click=null,this.panners=[],this.xTimeClicks=[],this.settings=e,console.log("chartSettings",e),this.options=s,console.log("noisyChartSettings",s),this.data=e.data,this.currentKey=null,this.currentIndex=0,this.isPlaying=!1,this.inProgress=!1,this.note=.2,this.sonicData={},this.xVar=e.keys[0],this.scale=null,this.dataKeys=n,console.log("dataKeys",n),this.furniturePlaying=!1,this.furniturePaused=!1,this.usedCursor=!1,this.keys=n,this.interactionAdded=!1,this.animateCircle=null,this.animateDiscrete=null,this.chartAnimation=null,this.chartID="chart",this.notes=[],this.speech=window.speechSynthesis,T.forEach(u=>{this.notes.push(u.Frequency)})}setAnimateCircle(e){this.animateCircle=e}setChartAnimation(e){this.chartAnimation=e}async loadSynths(e){console.log("Loading synths..."),k();let s=[-.75,.75];e.simultaneous||(console.log("yeh?"),s=[0,0]);let n=S().domain([0,e.selectedInstruments.length-1]).range(s);console.log("pan domain",n.range()),this.kickDrum=new Y().connect(this.destination),this.click=new F(j).connect(this.destination),e.selectedInstruments.forEach((i,t)=>{console.log(t);let o=X[i.instrument],a=o.Synth,u=i.instrument,l=o.Presets;console.log(a,u),console.log("pan value",n(t));let m=new _(n(t)).connect(this.destination);if(a!="Sampler"&&a!="Player"){let d=new I[a](l);return d.connect(m),this.synths[t]=d,!0}else if(a=="Sampler"&&(console.log("Sampler"),u!="Sad Trombone")){l.onload=()=>(console.log("samples loaded"),!0);let d=new I[a](l);d.connect(m),this.synths[t]=d}})}beep(e){return new Promise((s,n)=>{c.stop(),c.cancel();let i=this.synths[0];i.unsync(),i.triggerAttackRelease(e,.5),setTimeout(t,500);function t(){s({status:"success"})}})}speaker(e){return new Promise((s,n)=>{let i=this;if("speechSynthesis"in window){var t=new SpeechSynthesisUtterance;t.text=e,t.lang="en-GB";let o=B();o=="Firefox"&&(t.rate=1.1,t.lang="en-AU"),o=="Safari"&&(t.rate=1.1),i.speech.speak(t),t.onend=function(){s({status:"success"})}}else s({status:"no txt to speach"})}).catch(function(s){reject(s)})}setupSonicData({data:e,options:s,keys:n=[],exclude:i=[]}){console.log("Setting up data and synth");let t=this;t.options=s,console.log("options",t.options),this.settings.xFormat,t.settings.audioRendering&&(t.audioRendering=t.settings.audioRendering);let o=e.length,u=Object.keys(e[0]).slice(1).length,l=o*u;t.note=t.options.duration/l,t.synths,t.click,t.hasRun;let m=t.dataKeys,d=[];n.length===0&&(n=m),t.currentKey=n[0];let y=t.xVar;t.lowestVal={key:n[0],value:e[0][n[0]],[y]:e[0][t.xVar]},t.highestVal={key:n[0],value:e[0][n[0]],[y]:e[0][t.xVar]},n.forEach(function(r){t.sonicData[r]=[],e.forEach((h,x)=>{if(h[r]!=null){let g={};g[t.xVar]=h[t.xVar],g[r]=h[r],g.sonic_index=x,t.sonicData[r].push(g),d.push(h[r]),g[r]>t.highestVal.value&&(t.highestVal.key=r,t.highestVal.value=h[r],t.highestVal[y]=h[t.xVar]),g[r]<t.lowestVal.value&&(t.lowestVal.key=r,t.lowestVal.value=h[r],t.lowestVal[y]=h[t.xVar])}else{let g={};g[t.xVar]=h[t.xVar],g[r]=h[r],g.sonic_index=x,t.sonicData[r].push(g)}})}),t.xTimeClicks=[];let C=[];e.forEach((r,h)=>{C.push(r[y])}),t.settings.timeClick&&(t.xTimeClicks=$(C,t.settings.timeClick));let f=[t.options.low,t.options.high];if(console.log("range",f),t.settings.domainY=K(d),t.settings.domainX=K(e,r=>r[t.xVar]),t.options.invertAudio&&(console.log("inverting"),f=f.reverse()),t.scale=D().domain(t.settings.domainY).range(f),t.options.scaleNotes){console.log("Clamping to notes");let r=this.notes.findIndex(x=>x==t.options.low),h=this.notes.findIndex(x=>x==t.options.high);f=this.notes.slice(r,h+1),t.options.invertAudio&&(f=f.reverse())}t.options.scaleNotes?t.scale=S().domain(t.settings.domainY).range(f):t.scale=D().domain(t.settings.domainY).range(f),t.synthLoaded=!0}async playPause(){let e=this;if(L.resume(),console.log("isPlaying",e.isPlaying,"inProgress",e.inProgress,"usedCursor",e.usedCursor,"furniturePlayer",e.furniturePlaying,"furniturePaused",e.furniturePaused),!e.runOnce&&!e.inProgress&&!e.furniturePlaying?(console.log("playing furniture"),k(),console.log("currentIndex",e.currentIndex,e.synths),e.synths[e.currentIndex].context.resume(),await e.playFurniture()):e.furniturePlaying&&!e.furniturePaused?(console.log("pausing furniture"),e.speech.pause(),e.furniturePaused=!0):e.furniturePlaying&&e.furniturePaused&&(e.speech.resume(),e.furniturePaused=!1),!e.isPlaying&&!e.inProgress&&!e.usedCursor&&!e.furniturePlaying)if(console.log("playing"),e.options.simultaneous==!1)for await(const s of this.dataKeys)console.log("dataKey",s),await e.speaker(`${s}`),await e.playAudio([s]);else e.options.simultaneous==!0&&(console.log("simultaneous",this.dataKeys),await e.playAudio(this.dataKeys));else if(!e.isPlaying&&e.inProgress&&e.usedCursor){console.log("playing from cursor"),console.log("yeh");let s=e.dataKeys.indexOf(e.currentKey);console.log(s);for(let n=s;n<e.dataKeys.length;n++)e.currentKey=e.dataKeys[n],await e.speaker(`${e.currentKey}`),await e.playAudio([e.currentKey])}else e.isPlaying&&e.inProgress?(console.log("pause"),e.isPlaying=!1,c.pause()):!e.isPlaying&&e.inProgress&&(console.log("restart"),e.isPlaying=!0,c.start())}async moveCursor(e){let s=this;console.log("timeSettings",s.timeSettings),s.usedCursor=!0,s.isPlaying=!1,s.inProgress=!0,console.log("Move cursor",e),c.pause(),s.currentIndex=s.currentIndex+e,s.currentIndex>=s.sonicData[s.currentKey].length&&(s.currentIndex=0),s.currentIndex<0&&(s.currentIndex=s.sonicData[s.currentKey].length-1);let n=s.sonicData[s.currentKey][s.currentIndex],i=n[s.xVar],t=n[s.currentKey];function o(){s.speaker(v(i,s.settings.xAxisDateFormat)),s.speaker(P(t)),s.animateCircle(i,t,s.currentKey),s.beep(s.scale(t))}s.speech.speaking?(s.speech.cancel(),setTimeout(()=>{o()},100)):o()}moveSeries(e){let s=this;s.usedCursor=!0,s.isPlaying=!1,s.inProgress=!0,c.pause();let n=s.dataKeys.indexOf(s.currentKey);n=n+e,n>=s.dataKeys.length&&(n=0),n<0&&(n=s.dataKeys.length-1),s.currentKey=s.dataKeys[n];let i=s.sonicData[s.currentKey][s.currentIndex],t=i[s.xVar],o=i[s.currentKey];s.speaker(s.currentKey),s.speaker(P(o)),s.animateCircle(t,o,s.currentKey),s.beep(s.scale(o))}restart(){console.log("restart");let e=this;c.pause(),e.isPlaying=!1,e.inProgress=!1,e.runOnce=!1,e.furniturePlaying=!1,e.furniturePaused=!1,e.usedCursor=!1,e.currentKey=e.dataKeys[0],e.currentIndex=0,e.playPause()}addInteraction(e=null){let s=this;if(!s.interactionAdded){if(s.chartID){let i=document.getElementById("interactionZone");i.tabIndex=0,i.addEventListener("keypress",this.handleKeyPress)}const n=[{id:"play",text:"play/pause",function:()=>s.playPause()},{id:"restart",text:"restart",function:()=>s.restart()},{id:"datumNext",text:"cursor forward",function:()=>s.moveCursor(1)},{id:"datumPrevious",text:"cursor back",function:()=>s.moveCursor(-1)},{id:"seriesNext",text:"series forward",function:()=>s.moveSeries(1)},{id:"seriesBack",text:"series back",function:()=>s.moveSeries(1)}];if(e){let i=document.getElementById(e);i.innerHTML="",n.forEach(o=>{let a=document.createElement("button");a.textContent=o.text,a.onclick=o.function,a.id=o.id,a.id=o.id,i.appendChild(a)}),document.getElementById("play").addEventListener("keyup",o=>{o.code==="Space"&&o.preventDefault()})}s.interactionAdded=!0}}}export{U as default};
